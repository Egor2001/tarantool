-- test-run result file version 2
net_box = require('net.box')
 | ---
 | ...
fiber = require('fiber')
 | ---
 | ...
env = require('test_run')
 | ---
 | ...
test_run = env.new()
 | ---
 | ...

box.schema.user.grant('guest', 'replication')
 | ---
 | ...
box.schema.user.grant('guest','read,write,execute,create,drop','universe')
 | ---
 | ...
test_run:cmd("create server test with rpl_master=default, script='replication/replica_timeout.lua'")
 | ---
 | - true
 | ...
test_run:cmd("start server test with args='3'")
 | ---
 | - true
 | ...

_ = box.schema.space.create('counter')
 | ---
 | ...
_ = box.space.counter:create_index('primary')
 | ---
 | ...

test_run:cmd("switch test")
 | ---
 | - true
 | ...
net_box = require('net.box')
 | ---
 | ...
fiber = require('fiber')
 | ---
 | ...
test_run:cmd("set variable default_uri to 'default.listen'")
 | ---
 | - true
 | ...
con1 = net_box.connect(default_uri)
 | ---
 | ...
function check(t) fiber.create(function() fiber.sleep(t) con1:call('box.space.counter:auto_increment', {{t}}) end) end
 | ---
 | ...

test_run:cmd("switch default")
 | ---
 | - true
 | ...
test_run:cmd("set variable test_uri to 'test.listen'")
 | ---
 | - true
 | ...
test_con = net_box.connect(test_uri)
 | ---
 | ...
graceful_con = net_box.connect(test_uri)
 | ---
 | ...
graceful_con.space._session_settings:update('graceful_shutdown', {{'=', 2, true}})
 | ---
 | - ['graceful_shutdown', true]
 | ...
graceful_con.space._session_settings:select{}
 | ---
 | - - ['error_marshaling_enabled', false]
 |   - ['graceful_shutdown', true]
 |   - ['sql_default_engine', 'memtx']
 |   - ['sql_defer_foreign_keys', false]
 |   - ['sql_full_column_names', false]
 |   - ['sql_full_metadata', false]
 |   - ['sql_parser_debug', false]
 |   - ['sql_recursive_triggers', true]
 |   - ['sql_reverse_unordered_selects', false]
 |   - ['sql_select_debug', false]
 |   - ['sql_vdbe_debug', false]
 | ...
inserted_num = 0
 | ---
 | ...
graceful_con:shutdown()
 | ---
 | - true
 | ...
for time = 1, 10, 2 do inserted_num = inserted_num + 1 test_con:call('check', {time}) end
 | ---
 | ...

fiber.sleep(1)
 | ---
 | ...
test_run:cmd("stop server test")
 | ---
 | - true
 | ...

graceful_con:ping()
 | ---
 | - false
 | ...
net_box.connect(test_uri):ping()
 | ---
 | - false
 | ...
test_con:ping()
 | ---
 | - false
 | ...

fiber.sleep(3)
 | ---
 | ...
box.space.counter:select()
 | ---
 | - - [1, 1]
 | ...
inserted_num
 | ---
 | - 5
 | ...

test_run:cmd("delete server test")
 | ---
 | - true
 | ...
box.space.counter:drop()
 | ---
 | ...
box.schema.user.revoke('guest', 'replication')
 | ---
 | ...
box.schema.user.revoke('guest','read,write,execute,create,drop','universe')
 | ---
 | ...
